You are analyzing a financial question to identify all values needed to answer it.

QUESTION: {{ question }}

{% if previous_results and previous_results|length > 0 %}
PREVIOUS RESULTS AVAILABLE (listed from oldest to newest):
{% for var_name, info in previous_results.items() %}
[Turn {{ info.turn }}] {{ var_name }}:
  Description: "{{ info.description }}"
  Question: "{{ info.question }}"
  Answer: {{ info.answer }}{% if info.scale %} ({{ info.scale }}){% endif %}
{%- if loop.last %}
  ← THIS IS THE MOST RECENT RESULT!
{%- endif %}

{% endfor %}
{% endif %}

CALCULATION RULES AND PATTERNS:
{{ calculation_rules }}

The rules above describe common patterns in financial questions and how to interpret them.
Please consult these rules when classifying semantic types and understanding question intent.

TASK:
Analyze this question and identify all values needed to answer it.

STEP 0: Understand Metric Context from Previous Turns (CRITICAL!)

**CRITICAL - "Total Sum" Patterns:**

**Pattern 1: "Total sum including X"** (Cumulative Addition)
- "Total sum including X" means ADD X TO THE PREVIOUS SUM, not just get X!
- Pattern: Previous turn asked for "sum of A+B", current turn asks for "total sum including C"
- This means: Take the previous sum AND ADD C to it
- Example:
  * Turn 3: "what is the sum of A and B?" → result = 240000
  * Turn 4: "what is the total sum including C in location?" → result = 240000 + C
  * NOT just C alone!
- Keywords that indicate this pattern:
  * "total sum including..."
  * "grand total including..."
  * "cumulative total including..."
- Implementation: Use BOTH the previous sum result AND the new specific value mentioned

**Pattern 2: "Total sum of X"** (Grand Total - Sum ALL Values)
- "Total sum of X" (WITHOUT "including") means sum ALL values that match the criteria
- This is a GLOBAL question asking for the grand total across the entire conversation
- Pattern: After discussing multiple individual values, question asks for "total sum"
- Example:
  * Turn 1: "square feet of facility A" → 160000
  * Turn 2: "square feet of facility B" → 80000
  * Turn 3: "sum of those values" → 240000
  * Turn 4: "total sum including facility C" → 240000 + 70000 = 310000
  * Turn 5: "total sum including facility D" → 240000 + 67000 = 307000
  * Turn 6: "what is the total sum of square feet?" → 160000 + 80000 + 70000 + 67000 = 377000
  * NOT just the Turn 3 sum (240000)! Sum ALL individual facility values!
- How to identify: Question asks for "total" with broad scope (e.g., "total sum of X owned")
- Implementation: Identify ALL individual values from previous results that match the criteria (e.g., "owned"), sum them
- DO NOT just return a previous partial sum result!

Before identifying values, understand what SPECIFIC METRIC TYPE the conversation is about:

METRIC CONTEXT INHERITANCE:
- When previous turns establish a specific metric (e.g., "compensation expense", "net revenue", "total debt"):
  * ALL subsequent questions inherit that metric context UNLESS they explicitly mention a different metric
  * Vague terms like "total", "expenses", "value" should be interpreted within the established metric context

EXAMPLES:

Example 1 - Compensation Expense Context:
  Turn 1: "compensation expense in 2015" → 43
  Turn 2: "what about in 2014?" → asks for compensation expense 2014 (NOT all expenses)
  Turn 3: "total... in 2015 and 2014" → sum of compensation expenses (NOT all expenses)
  Turn 4: "total expenses including 2013" → STILL means compensation expenses including 2013!
  * The word "expenses" here is shorthand for "compensation expenses" established in Turn 1
  * It does NOT mean "sum ALL expenses for 2013"

Example 2 - Revenue Context:
  Turn 1: "net revenue in 2017" → 500
  Turn 2: "what about 2016?" → net revenue 2016
  Turn 3: "total for both years" → sum of net revenue (NOT gross revenue, NOT total income)

WHEN TO OVERRIDE CONTEXT:
Only break from established context if the question EXPLICITLY mentions a different metric:
- "what about total income?" → NEW metric (total income), breaks from net revenue context
- "gross revenue for 2015?" → NEW metric (gross revenue), breaks from net revenue context

IF IN DOUBT:
Look at ALL previous turn Questions and Descriptions - what specific metric appears repeatedly?
That is the context metric for subsequent questions.

NOTE: Pronouns and temporal references have been resolved in the question above.

STEP 1: Identify Values and Create SHORT Variable Names

{% if table_metadata %}
**TABLE ROW/COLUMN LABELS IN THE KNOWLEDGE GRAPH:**

Row Labels (table rows):
{% for row in table_metadata.row_labels %}
- "{{ row }}"
{% endfor %}

Column Labels (table columns):
{% for col in table_metadata.column_labels %}
- "{{ col }}"
{% endfor %}

**USE THESE LABELS TO IDENTIFY COMPOUND METRIC NAMES!**
If the question phrase matches a label above EXACTLY, it's ONE value (not multiple to add).

{% if metric_comments and metric_comments|length > 0 %}
**METRIC FOOTNOTE DEFINITIONS (CRITICAL FOR SEMANTIC MATCHING!):**

These footnotes explain what table metrics SEMANTICALLY represent:
{% for row_label, explanation in metric_comments.items() %}
- "{{ row_label }}": {{ explanation }}
{% endfor %}

**CRITICAL - Use Footnotes to Recognize Compound Metrics:**
When the question asks for a phrase like "contractual principal, interest and fees":
1. Check if ANY footnote DEFINES that phrase!
2. Example: Footnote says "outstanding balance (a) represents the sum of contractual principal, interest and fees"
   → Then "outstanding balance (a)" IS the metric the question is asking for!
   → Don't split into: contractual_principal + interest + fees
   → Instead create ONE variable: outstanding_balance

How to identify semantic equivalence:
- Question phrase: "contractual principal, interest and fees"
- Footnote: "outstanding balance (a) represents the sum of contractual principal, interest and fees"
- Match! The question is asking for the "outstanding balance (a)" row!
- Create: outstanding_balance_2008, outstanding_balance_2009 (if years 2008 and 2009 are mentioned)
{% endif %}
{% endif %}

**CRITICAL - Do NOT Split Compound Facility/Metric Names:**
- Facility/location names with "and" are often SINGLE entities, not multiple values to add!
- **CRITICAL**: "total X and Y" often means ONE COMPOUND METRIC NAME, NOT "add X and Y"!
{% if table_metadata %}
- **CHECK THE TABLE LABELS ABOVE FIRST!** If the phrase appears there, it's ONE entity!
{% endif %}
- Examples of SINGLE compound entities:
  * "total restricted cash and marketable securities" → ONE metric (with "total" in the name), NOT restricted_cash + marketable_securities
  * "global supply chain distribution and administration offices" → ONE facility type, not two
  * "research and development offices" → ONE facility type, not two separate things
  * "sales and marketing expenses" → ONE expense category, not two
- How to identify compound names vs. multiple values:
  * If it describes operations AT THE SAME LOCATION → ONE value
  * If it describes A SINGLE CATEGORY of activity → ONE value
  * If the question asks for "the X" (singular) → ONE value, not multiple
  * **If "total" appears BEFORE "X and Y"** → Check KG first! It's likely ONE metric name, not "sum of X and Y"
{% if table_metadata %}
  * **If the phrase matches a table row/column label above** → It's ONE entity!
{% endif %}
- Example WRONG interpretation:
  * Question: "what was the total restricted cash and marketable securities in 2012?"
  * WRONG: Two values to add: (1) restricted_cash_2012 + (2) marketable_securities_2012
  * RIGHT: ONE value: total_restricted_cash_and_marketable_securities_2012 (compound metric name)
- Example WRONG interpretation:
  * Question: "square feet of owned global supply chain distribution and administration offices"
  * WRONG: Two values: (1) global_supply_chain + (2) administration
  * RIGHT: ONE value: global_supply_chain_distribution_admin_offices
- When in doubt, check if the phrase appears in the table labels above - if yes, it's ONE entity!

CRITICAL: For EVERY value you identify as needed, you MUST follow this process:

FOR EACH VALUE NEEDED:

  A. CHECK PREVIOUS RESULTS FIRST (MANDATORY!)
     Look at the PREVIOUS RESULTS AVAILABLE section above
     - Does the EXACT value you need already exist there?
     - Check each previous result's Description and Answer
     - Is this the value you need? (same entity, same metric, same time period?)

     **CRITICAL - Grand Total Pattern (Pattern 2) - ONLY if NO "including":**
     - **ONLY applies when**: Question asks "total sum of X" WITHOUT the word "including"
     - **Does NOT apply if**: Question contains "including" → Use Pattern 1 instead (cumulative addition)
     - If the question asks for "total sum of X" (no "including"), it's asking for a GLOBAL grand total
     - DON'T just return a previous partial sum! Instead, identify ALL INDIVIDUAL values that match the criteria
     - Example:
       * Question: "what is the total sum of square feet owned?" (NO "including")
       * Previous results include:
         - Facility A: 160000 (individual - description mentions specific location)
         - Facility B: 80000 (individual - description mentions specific location)
         - Sum A+B: 240000 (partial sum - description contains "sum")
         - Facility C: 70000 (individual - description mentions specific location)
         - Sum including C: 310000 (partial sum - description contains "sum")
         - Facility D: 67000 (individual - description mentions specific location)
       * CORRECT: Return A, B, C, D (all individual values) → 160000 + 80000 + 70000 + 67000 = 377000
       * WRONG: Return "Sum including C" (310000) or "Sum A+B" (240000) - these are PARTIAL sums!
     - How to identify individual values vs. sums in descriptions:
       * Individual: Description mentions SPECIFIC facility/location/entity (e.g., "in Bogart", "in Smithfield", "Dublin Ireland")
       * Sum: Description contains words like "sum", "total", "including", "cumulative"
     - **Key test**: Does the question contain "including"?
       * If YES → Pattern 1 (cumulative addition), not Pattern 2!
       * If NO and asks for "total" → Pattern 2 (grand total of all individuals)

     **CRITICAL - Contextual Disambiguation:**
     - If the question contrasts TWO different values (e.g., "X divided by Y", "X compared to Y"):
       * Check if ONE clearly refers to previous result (e.g., "the sum", "this change")
       * Check if the OTHER describes a DIFFERENT scope (e.g., "total", "overall", "grand")
       * If previous result is a PARTIAL total but question asks for GRAND total → They are DIFFERENT values!
       * Example: Previous = "sum of A+B", Question = "sum divided by total" → "sum" = previous, "total" = NEW (grand total from KG)

     **CRITICAL - "Percent Change" After "Net Change":**
     - Pattern: Turn N asks for "net change from X to Y", Turn N+M asks for "percent change"
     - When question is JUST "what is the percent change?" (no explicit years or values):
       * Check if previous results include BOTH:
         (1) A "net change" or "change" value
         (2) A base value (starting value, earlier period value)
       * If YES: Use those two previous results! Formula: net_change / base_value
       * Do NOT re-extract start/end values from KG to recalculate the change
     - Example:
       * Turn 1: "net change from 2007 to 2009" → net_change = 100
       * Turn 2: "the 2009 value" → value_2009 = 500 (this is the base/reference)
       * Turn 3: "what is the percent change?" → Use net_change / value_2009, NOT (new - old) / old

     IF YES (exact match found):
       → Use source: "previous_result"
       → COPY the EXACT variable name from PREVIOUS RESULTS AVAILABLE
       → DO NOT create a new variable name
       → DO NOT mark it as "knowledge_graph"

  B. ONLY IF NOT IN PREVIOUS RESULTS: Create NEW variable
     If the value does NOT exist in previous results:
       → Use source: "knowledge_graph"
       → Create SHORT, CLEAR variable name with abbreviations
       → Include entity + metric (e.g., "sp500_performance", "ups_revenue")
       → Include year if specified (e.g., "2007", "2008")

     GOOD variable names (SHORT and CLEAR):
     ✓ change_sp500_performance
     ✓ ups_revenue_2007
     ✓ net_sales_2001
     ✓ total_debt_2015

     BAD variable names (TOO VERBOSE):
     ❌ what_was_the_change_in_the_performance_of_the_unit
     ❌ and_what_was_the_total_of_net_sales_in_2000
     ❌ what_were_revenues_in_2008

  C. Write a DETAILED description of what it represents
     - Descriptions can be long and explicit
     - Descriptions are metadata, not code

  D. Classify its semantic_type:
     - "change_value" - represents a change/difference/variation (preserve sign!)
     - "total_value" - represents a sum or total
     - "monetary_value" - represents money amount
     - "percentage_value" - represents a percentage
     - "count_value" - represents a count/quantity
     - "ratio_value" - represents a ratio

     **CRITICAL - Ratio vs Percentage Disambiguation:**
     - "X in relation to Y" = RATIO (X/Y), NOT percentage!
     - "X represent in relation to Y" = RATIO (X/Y), NOT percentage!
     - "X as a percentage of Y" = PERCENTAGE (X/Y * 100)
     - "what percentage is X of Y" = PERCENTAGE (X/Y * 100)

     Examples:
     - "how much does 240 represent in relation to 183?" → 240/183 = 1.3114 (RATIO - semantic_type: "ratio_value")
     - "what percentage is 240 of 183?" → (240/183)*100 = 131.14% (PERCENTAGE - semantic_type: "percentage_value")

     When you see "in relation to" WITHOUT the word "percentage":
     → Use semantic_type: "ratio_value"
     → Result description should say "ratio" NOT "percentage"

     When you see "percentage" or "percent" explicitly:
     → Use semantic_type: "percentage_value"
     → Result description should say "percentage"

WARNING: DO NOT create new "knowledge_graph" variables for values that already exist in PREVIOUS RESULTS!
This is a common mistake that causes unnecessary queries and wrong answers!

CRITICAL: Variable names MUST be valid Python identifiers:
- MUST NOT start with a digit
- MUST NOT contain special characters like & , . - / spaces
- ONLY use letters, numbers, and underscores
- Use abbreviations for long entity names:
  - "s&p 500 index" → sp500 or sp500_index
  - "united parcel service" → ups
  - "net sales" → net_sales

STEP 2: Name the RESULT Variable
After identifying what values you need (STEP 1), you must also name the RESULT that will be computed.

- Create a SHORT, CLEAR variable name for what this question computes
- Include entity + metric type
- Include time period if relevant
- Write a DETAILED description of what it represents

Examples:
- Question: "what was the change in S&P 500 performance from 2004 to 2009?"
  Result variable: "change_sp500_performance_2004_2009"
  Description: "Change in S&P 500 index performance from 2004 to 2009"

- Question: "what were revenues in 2008?"
  Result variable: "revenues_2008"
  Description: "Total revenues in year 2008"

- Question: "how much does this change represent in percentage?"
  Result variable: "change_percentage" (or reuse the change variable name if computing percentage of it)
  Description: "Percentage representation of the change in [entity] [metric]"

OUTPUT (JSON):

Example showing SHORT variable names and variable-based resolution:
{
  "resolved_question": "how much does change_sp500_performance represent in relation to sp500_performance_2004, in percentage?",
  "values": {
    "change_sp500_performance": {
      "description": "Change in S&P 500 index performance from 2004 to 2009",
      "semantic_type": "change_value",
      "source": "knowledge_graph"
    },
    "sp500_performance_2004": {
      "description": "S&P 500 index performance value in 2004",
      "semantic_type": "total_value",
      "source": "knowledge_graph"
    }
  },
  "result": {
    "variable_name": "sp500_change_percentage_2004_2009",
    "description": "Percentage that the S&P 500 performance change represents relative to 2004 performance"
  }
}

Example using previous result:
{
  "resolved_question": "how much does change_revenue represent in relation to revenue_2000, in percentage?",
  "values": {
    "change_revenue": {
      "description": "Change in revenue from 2000 to 2001",
      "semantic_type": "change_value",
      "source": "previous_result"
      // ← Used EXACT name from PREVIOUS RESULTS AVAILABLE
    },
    "revenue_2000": {
      "description": "Revenue in year 2000",
      "semantic_type": "monetary_value",
      "source": "knowledge_graph"
    }
  },
  "result": {
    "variable_name": "revenue_change_percentage",
    "description": "Percentage that the revenue change represents relative to year 2000 revenue"
  }
}

CRITICAL RULES:
1. If source="previous_result": COPY-PASTE the EXACT variable name from PREVIOUS RESULTS AVAILABLE
2. If source="knowledge_graph": Create SHORT, CLEAR variable name with abbreviations
3. In resolved_question: Use VARIABLE NAMES, not natural language
4. Descriptions should be DETAILED - they're metadata, not code
5. Variable names must be valid Python identifiers (no spaces, special chars, can't start with digit)
6. ALWAYS include a "result" field with variable_name and description for what will be computed

Generate the JSON now:
